# ---- Load libraries ----
library(tidyverse)

# source("functions.R")

# ---- Load data ----
# VI MSOA
vi_msoa <- read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/output/vulnerability-MSOA-UK.csv")

# VI LA
vi_la <- read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/output/vulnerability-LA.csv")

# VI Local Resilience Forums
vi_lrf <- read_csv("https://github.com/britishredcrosssociety/covid-19-vulnerability/raw/master/output/vulnerability-lrf.csv")

# ---- Clean data -----
# - MSOA -
vi_msoa_clean <-
  vi_msoa %>% 
  select(MSOA11CD = Code,
         MSOA11NM = Name,
         ends_with("decile"),
         ends_with("rank"))

vi_la_clean <-
  vi_la %>% 
  select(LAD19CD = Code,
         LAD19NM = Name,
         starts_with("Extent"),
         ends_with("quintile"),
         ends_with("rank"))

vi_lrf_clean <- 
  vi_lrf %>% 
  select(LRF19CD,
         Name,
         starts_with("Extent"))

# ---- Calculated aggregated deciles based on extents ----
# vi_lrf_clean <- 
#   vi_lrf_clean %>% 
#   mutate(`Clinical Vulnerability decile` = calc_risk_quantiles("Extent of population living in highly clinically vulnerable areas", quants = 10))

# ---- Save to curated ----
vi_msoa_clean %>% 
  write_csv("data/processed/vulnerability index - msoa.csv")

vi_la_clean %>% 
  write_csv("data/processed/vulnerability index - la.csv")

vi_lrf_clean %>% 
  write_csv("data/processed/vulnerability index - lrf.csv")
