# ---- Load ----
library(tidyverse)
library(readxl)
library(httr)
library(geographr)
source("R/utils.R")

# Load CACI data computed in VI
living_alone_raw <-
  read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/CACI/living-alone-lsoa.csv")

# Filter to Wales
living_alone_lsoa <-
  living_alone_raw %>%
  filter(str_detect(LSOA11CD, "^W")) %>%
  rename(
    lsoa_code = LSOA11CD,
    num_alone = `No. people living alone`
  )

living_alone_lad <-
  living_alone_lsoa %>%
  left_join(lookup_lsoa_msoa, by = "lsoa_code") %>%
  left_join(population_lsoa, by = "lsoa_code") %>%
  left_join(lookup_msoa_lad, by = "msoa_code") %>%

  calculate_extent(
    var = num_alone,
    higher_level_geography = lad_code,
    population = total_population,
    weight_high_scores = TRUE  # For all ranks: 1 is most deprived
  )

living_alone_lad %>%
  write_rds("data/vulnerability/disasters-emergencies/wales/living-alone-lad.rds")
