# Load R packages
library(shiny)
library(leaflet)
library(geographr)
library(sf)
library(shinythemes)
library(readr)
library(tidyverse)

# setwd("R/vulnerability/disasters-emergencies/wales/shiny/")
rank_vul <- read_csv("index-weighted-vul.csv")
rank_cap <- read_csv("index-weighted-cap.csv")


rank_shp <-
  boundaries_lad %>%
  filter(str_detect(lad_code, "^W")) %>%
  left_join(rank_vul, by = "lad_code") %>%
  left_join(rank_cap, by = "lad_code") %>% 
  rename(
    deciles_vul = deciles.x,
    deciles_cap = deciles.y
  )

# Biviate map
# create 3 buckets for vulnerability deciles
quantiles_vul <- rank_shp %>%
  pull(deciles_vul) %>%
  quantile(probs = seq(0, 1, length.out = 4))

# create 3 buckets for capacity deciles
quantiles_cap <- rank_shp %>%
  pull(deciles_cap) %>%
  quantile(probs = seq(0, 1, length.out = 4))

bivariate_color_scale <- tibble(
  "3 - 3" = "#3F2949", # high inequality, high income
  "2 - 3" = "#435786",
  "1 - 3" = "#4885C1", # low inequality, high income
  "3 - 2" = "#77324C",
  "2 - 2" = "#806A8A", # medium inequality, medium income
  "1 - 2" = "#89A1C8",
  "3 - 1" = "#AE3A4E", # high inequality, low income
  "2 - 1" = "#BC7C8F",
  "1 - 1" = "#CABED0" # low inequality, low income
) %>%
gather("group", "fill")

# cut into groups defined above and join fill
rank_shp %<>%
  mutate(
    vul_quantiles = cut(
      deciles_vul,
      breaks = quantiles_vul,
      include.lowest = TRUE
    ),
    cap_quantiles = cut(
      deciles_cap,
      breaks = quantiles_cap,
      include.lowest = TRUE
    ),
    # by pasting the factors together as numbers we match the groups defined
    # in the tibble bivariate_color_scale
    group = paste(
      as.numeric(vul_quantiles), "-",
      as.numeric(cap_quantiles)
    )
  ) %>%
  # we now join the actual hex values per "group"
  # so each municipality knows its hex value based on the his gini and avg
  # income value
  left_join(bivariate_color_scale, by = "group")



pal_vul <- colorQuantile(
  palette = "magma",
  domain = rank_shp$deciles_vul,
  n = 3)

labels_vul <- sprintf(
  "<strong>%s</strong><br/>Rank %g",
  rank_shp$lad_name, rank_shp$deciles_vul
) %>% lapply(htmltools::HTML)

pal_cap <- colorQuantile(
  palette = "viridis",
  domain = rank_shp$deciles_cap,
  n = 3)

labels_cap <- sprintf(
  "<strong>%s</strong><br/>Rank %g",
  rank_shp$lad_name, rank_shp$deciles_cap
) %>% lapply(htmltools::HTML)

labels_bi <- sprintf(
  "<strong>%s</strong><br/>Vulnerability Rank %g <br/>Capacity Rank %g",
  rank_shp$lad_name, rank_shp$deciles_vul, rank_shp$deciles_cap
) %>% lapply(htmltools::HTML)

# bivariate_color_scale %<>%
#   separate(group, into = c("Vulnerability", "Capacity"), sep = " - ") %>%
#   mutate(vul = as.integer(Vulnerability),
#          cap = as.integer(Capacity))

# legend <- ggplot() +
#   geom_tile(
#     data = bivariate_color_scale,
#     mapping = aes(
#       x = vul,
#       y = cap,
#       fill = fill)
#   ) +
#   scale_fill_identity() +
#   labs(x = "Higher inequality ⟶️",
#        y = "Higher income ⟶️") +
#   theme_map() +
#   # make font small enough
#   theme(
#     axis.title = element_text(size = 6)
#   ) +
#   # quadratic tiles
#   coord_fixed()

ui <- fluidPage(theme = shinytheme("superhero"),
  navbarPage(
      "Resilience Index",
      tabPanel("Vulnerability",
               mainPanel(
                 leafletOutput("map_vulnerability")
                )
      ),
      tabPanel("Capacity",
               mainPanel(
                 leafletOutput("map_capacity")
                )
      ),
      tabPanel("Bivate Map",
               mainPanel(
                 leafletOutput("map_biviate")
                )
      )
  )
)

server <- function(input, output, session) {

  output$map_vulnerability <- renderLeaflet({
    leaflet(data = rank_shp) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addPolygons(
      color = "#aca9a9a8",
      weight = 1,
      smoothFactor = 0.5,
      opacity = 1,
      fillOpacity = 0.7,
      fillColor = ~pal_vul(deciles_vul),
      highlightOptions = highlightOptions(
        weight = 5,
        color = "#9374CCE7",
        fillOpacity = 0.7,
        bringToFront = TRUE),
      label = labels_vul,
      labelOptions = labelOptions(
        style = list("font-weight" = "normal", padding = "3px 8px"),
        textsize = "15px",
        direction = "auto")
      ) %>%
    addLegend("bottomleft", pal = pal_vul, values = ~deciles_vul,
        title = "Vulneralbility Index", opacity = 1
      )
  })

  output$map_capacity <- renderLeaflet({
    leaflet(data = rank_shp) %>% 
    addProviderTiles(providers$CartoDB.Positron) %>%
    addPolygons(
      color = "#aca9a9a8",
      weight = 1,
      smoothFactor = 0.5,
      opacity = 1,
      fillOpacity = 0.7,
      fillColor = ~pal_cap(deciles_cap),
      highlightOptions = highlightOptions(
        weight = 5,
        color = "#9374CCE7",
        fillOpacity = 0.7,
        bringToFront = TRUE),
      label = labels_cap,
      labelOptions = labelOptions(
        style = list("font-weight" = "normal", padding = "3px 8px"),
        textsize = "15px",
        direction = "auto")
      ) %>%
    addLegend("bottomleft", pal = pal_cap, values = ~deciles_vul,
        title = "Capacity Index", opacity = 1
      )
  })


  output$map_biviate <- renderLeaflet({
    leaflet(data = rank_shp) %>% 
    addProviderTiles(providers$CartoDB.Positron) %>%
    addPolygons(
      color = "#aca9a9a8",
      weight = 1,
      smoothFactor = 0.5,
      opacity = 1,
      fillOpacity = 0.7,
      fillColor = rank_shp$fill,
      highlightOptions = highlightOptions(
        weight = 5,
        color = "#9374CCE7",
        fillOpacity = 0.7,
        bringToFront = TRUE),
      label = labels_bi,
      labelOptions = labelOptions(
        style = list("font-weight" = "normal", padding = "3px 8px"),
        textsize = "15px",
        direction = "auto")
      )
  })

}

shinyApp(ui, server)
