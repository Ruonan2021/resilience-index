library(tidyverse)
library(readxl)
library(geographr)

source("R/utils.R") # download_file() & calculate_extent()

# Technical notes of IMD indicators
# Page 52 https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833951/IoD2019_Technical_Report.pdf
# A bespoke geographic information system application was used to calculate the road
# distance to the closest service from the population weighted centroid of each Output
# Area. To create an average road distance for the Lower-layer Super Output Area, a
# population-weighted mean of the Output Area road distances was used. Each Output Area
# score was weighted according to the proportion of the Lower-layer Super Output Area
# population that is within the Output Area, and the weighted scores summed. The Output
# Area level population estimates used for population-weighting were taken from mid-2017
# small area population estimates at Output Area level published by the Office for National
# Statistics.

# Data source: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
# File 8 on this landing page
tf <- download_file(
  "https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833992/File_8_-_IoD2019_Underlying_Indicators.xlsx",
  "xlxs"
)

raw_imd <- read_excel(tf, sheet = "IoD2019 Barriers Domain")

imd_distance <- raw |>
  select(lsoa_code = "LSOA code (2011)", 
         ltla_code = "Local Authority District code (2019)", 
         supermarket_dist_km = "Road distance to general store or supermarket indicator (km)",
         gp_dist_km = "Road distance to a GP surgery indicator (km)"
         )

# Technical notes: https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/healthandwellbeing/methodologies/methodsusedtodevelopthehealthindexforengland2015to2018
# defined as the average minimum “as the crow flies” distance from households in the local authority to the nearest service. 
# This has been calculated using postcode centroids from the ONS National Statistics Postcode Lookup (NSPL).

# The Health Index has been scaled to a base of 100 for England, with base year of 2015. Values higher 
# than 100 indicate better health than England 2015, and values below 100 indicate worse health.
tf <- download_file("https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fhealthandsocialcare%2fhealthandwellbeing%2fdatasets%2fhealthindexengland%2f2015to2018/hibetadatatablesv2.xlsx",
                    ".xlsx")


raw_ons <- read_excel(tf, sheet = "2018", skip = 13)

ons_distance <- raw_ons |>
  select(utla_code = "...1", 
         utla_name = "...4",
         gp_dist = "Distance to GP services",
         pharm_dist = "Distance to pharmacies"
  )

# Distances calculated in COVID VI via the following scripts:
# https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/master/prep%20food%20bank%20accessibility.py
# https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/master/prep%20hospitals%20accessibility.py

# Method: Mean distance to nearest three foodbanks/hospitals from LSOA 2011 Pop Weighted Centroids (doesn't include mental health hospitals) - think is road distance rather than crow flies (to confirm this)

covid_vi_foodbank <- read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/foodbank/nearest-foodbanks-lsoas.csv")
covid_vi_hospital <- read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/hospital-data/nearest-hospitals-LSOA.csv")

covid_vi_foodbank_columns <- covid_vi_foodbank |>
  mutate(mean_distance_nearest_three_foodbanks_km = mean_distance_nearest_three_foodbanks/1000) |>
  select(lsoa_code = lsoa11cd, mean_distance_nearest_three_foodbanks_km)

covid_vi_hospital_columns <- covid_vi_hospital |>
  mutate(mean_distance_nearest_three_hospitals_km = mean_distance_nearest_three_hospitals/1000) |>
  select(lsoa_code = lsoa11cd, mean_distance_nearest_three_hospitals_km)

  
# LSOA to LAD lookup 
lsoa_lad_lookup <- population_lsoa |>
  select(lsoa_code, msoa_pop = total_population) |>
  left_join(lookup_lsoa_msoa, by = "lsoa_code") |>
  left_join(lookup_msoa_lad, by = "msoa_code") |>
  select(lsoa_code, lad_code, msoa_pop) |>
  left_join(imd_distance, by = "lsoa_code") |>
  left_join(covid_vi_foodbank_columns, by = "lsoa_code") |>
  left_join(covid_vi_hospital_columns, by = "lsoa_code") 


# Since the foodbanks and hospitals is the average of 3 closest but the supermarket and GP is just the closest to think about combining 



