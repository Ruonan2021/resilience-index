# Load packages ----
library(tidyverse)
library(geographr)
library(sf)

source("https://raw.githubusercontent.com/britishredcrosssociety/resilience-index/main/R/utils.R") # for download_file() & calculate_extent()

# Load data and prep ----
# Load CACI data computed in VI
raw <-
  read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/CACI/living-alone-lsoa.csv")

lsoa_pop <- population_lsoa |>
  select(lsoa_code, lsoa_name, total_population)

# Filter only England & join on MSOA and LA lookups
alone_england <- raw |>
  rename(lsoa_code = LSOA11CD, num_alone = `No. people living alone`) |>
  filter(str_detect(lsoa_code, "^E")) 

alone_england_prop <- alone_england |>
  left_join(lookup_lsoa_msoa, by = c("lsoa_code")) |>
  left_join(lookup_msoa_lad, by = c("msoa_code")) |>
  left_join(lsoa_pop) |>
  mutate(prop_living_alone = num_alone / total_population)

# Check no missings in indicator data
lookup_lsoa_msoa |>
  filter(str_detect(lsoa_code, "^E")) |>
  anti_join(alone_england)
  
living_alone_extent <-
  alone_england_prop |>
  calculate_extent(
    var = prop_living_alone,
    higher_level_geography = lad_code,
    population = total_population,
    weight_high_scores = TRUE # higher value means higher vulnerability
  ) 

# Save ---- 
living_alone_extent |>
  write_rds("data/vulnerability/disasters-emergencies/england/living-alone.rds")
