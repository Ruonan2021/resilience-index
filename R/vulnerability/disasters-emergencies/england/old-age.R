# Load packages ----
library(tidyverse)
library(geographr)
library(sf)

source("https://raw.githubusercontent.com/britishredcrosssociety/resilience-index/main/R/utils.R") # for download_file() & calculate_extent()

# Load data and prep ----
elderly <- population_lsoa |>
  rowwise() |>
  mutate(over_65 = sum(c_across(`66`:`90+`))) |>
  mutate(prop_over_65 = over_65/ total_population) |>
  select(lsoa_code, prop_over_65, total_population) |>
  left_join(lookup_lsoa_msoa, by = c("lsoa_code")) |>
  left_join(lookup_msoa_lad, by = c("msoa_code")) 

elderly_extent <-
  elderly |>
  calculate_extent(
    var = prop_over_65,
    higher_level_geography = lad_code,
    population = total_population,
    weight_high_scores = TRUE # higher value means higher vulnerability
  ) 

# Save ---- 
elderly_extent |>
  write_rds("data/vulnerability/disasters-emergencies/england/old-age.rds")
