# Load packages ----
library(tidyverse)
library(readxl)
library(geographr)
library(sf)

source("R/utils.R") # for download_file() & calculate_extent()

# Load data and prep ----
# Load in Government IMD data
# Source: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
tf <- download_file(
    "https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833970/File_1_-_IMD2019_Index_of_Multiple_Deprivation.xlsx",
    ".xlsx")

raw <- read_excel(tf, sheet = "IMD2019")

lsoa_pop <- population_lsoa |>
  select(lsoa_code, total_population)

imd_extent <-raw |>
  rename(lsoa_code = `LSOA code (2011)`, imd_rank = `Index of Multiple Deprivation (IMD) Rank`, lad_code = `Local Authority District code (2019)`) |>
  left_join(lsoa_pop) |>
  calculate_extent(
    var = imd_rank,
    higher_level_geography = lad_code,
    population = total_population,
    invert_percentiles = FALSE #lower value is worse
  )

# Save ---- 
imd_extent |>
  write_rds("data/vulnerability/disasters-emergencies/england/imd.rds")
