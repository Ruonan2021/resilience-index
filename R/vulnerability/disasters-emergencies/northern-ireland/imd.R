# ---- Load ----
library(dplyr)
library(httr)
library(readxl)
library(geographr)
library(classInt)
source("R/utils.R")

# Source: https://www.nisra.gov.uk/statistics/deprivation
GET(
  url = "https://www.nisra.gov.uk/sites/nisra.gov.uk/files/publications/NIMDM17_SOAresults.xls",
  write_disk(tf <- tempfile(fileext = ".ods"))
)

# For all ranks: 1 is most deprived
imd_raw <- read_excel(tf, sheet = "MDM")

imd_clean <-
  imd_raw %>%
  select(
    soa_code = SOA2001,
    overall_rank = `Multiple Deprivation Measure Rank \n(where 1 is most deprived)`
  ) %>% 
  as_tibble()

imd_soa <-
  imd_clean %>%
  mutate(
    deciles =
      quantise(
        overall_rank,
        num_quantiles = 10,
        highest_quantile_worst = TRUE
      )
  )

# ---- Calculate LAD Deciles ----
imd_lad_extent <-
  imd_clean %>%
  left_join(
    lookup_sa_soa_lgd %>% distinct(soa_code, lad_code = lgd_code), 
    by = "soa_code"
  ) %>%
  left_join(population_lad, by = "lad_code") %>% 
  
  calculate_extent(
    var = overall_rank,
    higher_level_geography = lad_code,
    population = total_population,
    invert_percentiles = FALSE
  )

imd_lad <-
  imd_lad_extent %>%
  mutate(rank = rank(extent)) %>%
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10
    )
  )

write_rds(
  imd_soa,
  "data/vulnerability/disasters-emergencies/northern-ireland/imd-soa.rds"
)
write_rds(
  imd_lad,
  "data/vulnerability/disasters-emergencies/northern-ireland/imd-lad.rds"
)
