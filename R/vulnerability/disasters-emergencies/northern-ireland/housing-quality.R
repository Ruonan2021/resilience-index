library(tidyverse)
library(geographr)
library(sf)
library(readxl)

source("R/utils.R")

lad_lookup <-
  boundaries_lad |>
  st_drop_geometry() |>
  filter(str_detect(lad_code, "^N"))

pop <-
  population_soa |>
  filter(sex == "All") |>
  select(soa_code, total_population)

raw_file <-
  download_file(
    "https://www.nisra.gov.uk/sites/nisra.gov.uk/files/publications/NIMDM17_SOAresults.xls",
    ".xls"
  )

# Rank 1 = most deprived
raw <-
  read_excel(
    raw_file,
    sheet = "Living Environment",
    range = "A1:F891"
  )

joined <-
  raw |>
  select(
    lad_name = LGD2014NAME,
    soa_code = SOA2001,
    quality_rank = `Housing Quality \nSub-Domain \n(Rank)`
  ) |>
  left_join(lad_lookup) |>
  left_join(pop) |>
  select(
    lad_code,
    soa_code,
    quality_rank,
    total_population
  )

# Lowest rank (!1) = most deprived

housing_quality <-
  joined |>
  mutate(quality_rank = invert_this(quality_rank)) |>
  calculate_extent(
    quality_rank,
    higher_level_geography = lad_code,
    population = total_population
  ) |>
  rename(housing_quality = extent)

housing_quality |>
  write_rds("data/vulnerability/disasters-emergencies/northern-ireland/housing-quality.rds")