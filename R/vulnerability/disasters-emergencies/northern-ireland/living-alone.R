# ---- Load ----
library(tidyverse)
library(readxl)
library(httr)
library(geographr)
source("R/utils.R")

# Load CACI data computed in VI
living_alone_raw <-
  read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/CACI/living-alone-lsoa.csv")

# Filter to Wales
living_alone_soa <-
  living_alone_raw %>%
  filter(str_detect(LSOA11CD, "^9")) %>%
  rename(
    soa_code = LSOA11CD,
    num_alone = `No. people living alone`
  )

living_alone_prop <-
  living_alone_soa %>%
  left_join(population_soa, by = "soa_code") %>%
  mutate(prop_living_alone = num_alone / total_population)

living_alone_prop_soa <-
  living_alone_prop %>%
  select(soa_code, num_alone, total_population, prop_living_alone) %>% 
  mutate(rank = rank(prop_living_alone)) %>%
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

living_alone_prop_lad <-
  living_alone_prop %>%
  left_join(
    lookup_sa_soa_lgd %>% distinct(soa_code, lad_code = lgd_code), 
    by = "soa_code"
  ) %>%
  calculate_extent(
    var = prop_living_alone,
    higher_level_geography = lad_code,
    population = total_population
  ) %>%
  mutate(rank = rank(extent)) %>%
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

living_alone_prop_soa %>%
  write_rds("data/vulnerability/disasters-emergencies/northern-ireland/living-alone-soa.rds")

living_alone_prop_lad %>%
  write_rds("data/vulnerability/disasters-emergencies/northern-ireland/living-alone-lad.rds")
