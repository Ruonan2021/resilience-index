library(readr)
library(tidyr)
library(dplyr)
library(stringr)
library(geographr)
source("R/utils.R")

# Calculate elderly population proportions for SOAs
elderly_soa <- 
  population_soa %>% 
  filter(sex == "All") %>% 

  rename(
    num_people = total_population,
    num_people_over_65 = `65+`
  ) %>% 
  
  mutate(proportion_over_65 = num_people_over_65 / num_people) %>%
  mutate(
    deciles = quantise(
      proportion_over_65,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  ) %>% 
  
  select(soa_code, num_people, num_people_over_65, proportion_over_65, deciles)

# For LAD, calculate extent on proportions
elderly_lad <-
  elderly_soa %>%
  select(-deciles, -num_people_over_65) %>%
  
  left_join(
    lookup_sa_soa_lgd %>% distinct(soa_code, lad_code = lgd_code), 
    by = "soa_code"
  ) %>%
  
  calculate_extent(
    var = proportion_over_65,
    higher_level_geography = lad_code,
    population = num_people
  ) %>%
  mutate(rank = rank(extent)) %>%
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

# Save
elderly_soa %>%
  write_rds("data/vulnerability/disasters-emergencies/northern-ireland/elderly-population-soa.rds")

elderly_lad %>%
  write_rds("data/vulnerability/disasters-emergencies/northern-ireland/elderly-population-lad.rds")
