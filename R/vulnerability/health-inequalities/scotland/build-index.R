# ---- Method ----
# The build method is adapated from the methods used to develop the Health Index
# for England. As the devolved nations versions of the Health Index are not
# measured across time, several aspects of the construction differ, and mirror
# those found in the Indices of Multiple Deprivation.

# Technical docs:
#   - https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/healthandwellbeing/methodologies/methodsusedtodevelopthehealthindexforengland2015to2018#overview-of-the-methods-used-to-create-the-health-index
#   - https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833951/IoD2019_Technical_Report.pdf

# Steps:
#   1. Scale (align) indicators so that higher value = worse health to align
#      with the other resilience indices (higher = worse).
#   x. Missing step: Apply functional transformations (e.g. log, square) to
#      address skewness in the distributions.
#   2. Weight the indicators within domains: Normalise to mean of 0 and SD +-1
#      and then apply MFLA.
#   3. Calculate domain scores: add weighted indicator scores and rank and
#      qunatise.
#   4. Combine domains with equal weighting to produce composite score: rank
#      and quantise output.

# ---- Load libraries and Functions ----
library(tidyverse)
source("R/utils.R")

# ---- Build Healthy Lives Domain ----
# Load indicators
healthy_lives_indicators <-
  load_indicators(
    path = "data/vulnerability/health-inequalities/scotland/healthy-lives",
    key = "lad_code"
  )

# 1. Scale (align) indicators - Higher value = worse health.
healthy_lives_scaled <-
  healthy_lives_indicators %>%
  mutate(
    gcse_qualifications_percent = gcse_qualifications_percent * -1,
    healthy_eating_percent = healthy_eating_percent * -1,
    job_related_training_percent = job_related_training_percent * -1,
    activity_levels_met_percent = activity_levels_met_percent * -1,
    vaccine_rate_mean = vaccine_rate_mean * -1,
    young_people_training_percent = young_people_training_percent * -1
  )

# 2. Weight the indicators within the domain
healthy_lives_weighted <-
  healthy_lives_scaled %>%
  weight_indicators_mfla()

# 3. Calculate domain scores
healthy_lives_scores <-
  healthy_lives_weighted %>%
  calculate_domain_scores(domain_name = "healthy_lives")

# ---- Build Healthy People Domain ----
# Load indicators
healthy_people_indicators <-
  load_indicators(
    path = "data/vulnerability/health-inequalities/scotland/healthy-people",
    key = "lad_code"
  )

# 1. Scale (align) indicators - Higher value = worse health.
healthy_people_scaled <-
  healthy_people_indicators %>%
  mutate(
    happiness_score_out_of_10 = happiness_score_out_of_10 * -1,
    healthy_life_expectancy_average = healthy_life_expectancy_average * -1,
    life_satisfaction_score_out_of_10 = life_satisfaction_score_out_of_10 * -1,
    life_worthwhileness_score_out_of_10 = life_satisfaction_score_out_of_10 * -1,
  )

# 2. Weight the indicators within the domain
healthy_people_weighted <-
  healthy_people_scaled %>%
  weight_indicators_mfla()

# 3. Calculate domain scores
healthy_people_scores <-
  healthy_people_weighted %>%
  calculate_domain_scores(domain_name = "healthy_people")

# ---- Build Healthy Places Domain ----
# Load indicators
healthy_places_indicators <-
  load_indicators(
    path = "data/vulnerability/health-inequalities/scotland/healthy-places",
    key = "lad_code"
  )

# 1. Scale (align) indicators - Higher value = worse health.
healthy_places_scaled <-
  healthy_places_indicators %>%
  mutate(
    private_outdoor_space_percent = private_outdoor_space_percent * -1,
  )

# 2. Weight the indicators within the domain
healthy_places_weighted <-
  healthy_places_scaled %>%
  weight_indicators_mfla()

# 3. Calculate domain scores
healthy_places_scores <-
  healthy_places_weighted %>%
  calculate_domain_scores(domain_name = "healthy_places")

# ---- Combine domains ----
# 4. Combine domains with equal weighting to produce composite score
health_inequalities_index <-
  healthy_lives_scores %>%
  # left_join(
  #   healthy_people_scores,
  #   by = "lad_code"
  # ) %>%
  left_join(
    healthy_places_scores,
    by = "lad_code"
  ) %>%
  calculate_composite_score(index_name = "health_inequalities")