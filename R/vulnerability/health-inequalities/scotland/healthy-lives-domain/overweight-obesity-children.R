library(readr)
library(httr)
library(dplyr)

# Source:https://scotland.shinyapps.io/ScotPHO_profiles_tool/
# Indicator: Child healthy weight in primary 1

# Interactively generate the data by:
#   1. Uncommenting the code below
#   2. Navigating the the source (above)
#   3. Clicking the 'Data' box
#   4. Selecting the relevant indicator (above)
#   5. Ticking 'All available geographies'
#   6. Moving the time period slider until the latest data shows
#   7. Right-clicking on 'Download data' and clicking 'Copy Link Location'
#   8. Pasting the link into the GET request below
#   9. Running the code
#   10. Recommenting the code

GET(
  "https://scotland.shinyapps.io/ScotPHO_profiles_tool/_w_17a0f340/session/73db77f108a709d62f4a00a1f128537b/download/download_table_csv?w=17a0f340",
  write_disk(tf <- tempfile(fileext = ".csv"))
)

child_weight_raw <-
  read_csv(tf)

unlink(tf)
rm(tf)

child_weight <-
  child_weight_raw %>%
  filter(area_type == "Council area") %>%
  select(
    lad_code = area_code,
    healthy_weight_percent = measure
  ) %>%
  mutate(
    unhealthy_weight_percent = (100 - healthy_weight_percent) / 100
  ) %>%
  select(-healthy_weight_percent)

write_rds(child_weight, "data/vulnerability/health-inequalities/scotland/overweight-children.rds")