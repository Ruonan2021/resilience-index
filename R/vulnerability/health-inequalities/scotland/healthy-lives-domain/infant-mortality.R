library(readr)
library(httr)
library(dplyr)

# Source:https://scotland.shinyapps.io/ScotPHO_profiles_tool/
# Indicator: Infant deaths, ages 0-1 years

if (file.exists("data/vulnerability/health-inequalities/scotland/infant-mortality.rds")) {
  infant_mortality <- read_rds("data/vulnerability/health-inequalities/scotland/infant-mortality.rds")
} else {
  stop("infant-mortality data is missing. Regenerate it using the steps below.")
}

# Interactively generate the data by:
#   1. Uncommenting the code below
#   2. Navigating the the source (above)
#   3. Clicking the 'Data' box
#   4. Selecting the relevant indicator (above)
#   5. Ticking 'All available geographies'
#   6. Moving the time period slider until the latest data shows
#   7. Right-clicking on 'Download data' and clicking 'Copy Link Location'
#   8. Pasting the link into the GET request below
#   9. Running the code
#   10. Recommenting the code

# GET(
#   "https://scotland.shinyapps.io/ScotPHO_profiles_tool/_w_bf38394a/session/b36bf6618e0e15fa0175acb6560866c3/download/download_table_csv?w=bf38394a",
#   write_disk(tf <- tempfile(fileext = ".csv"))
# )

# infant_mortality_raw <-
#   read_csv(tf)

# unlink(tf)
# rm(tf)

# infant_mortality <-
#   infant_mortality_raw %>%
#   filter(area_type == "Council area") %>%
#   select(
#     lad_code = area_code,
#     infant_mortality_per_1000 = measure
#   )

# write_rds(infant_mortality, "data/vulnerability/health-inequalities/scotland/infant-mortality.rds")