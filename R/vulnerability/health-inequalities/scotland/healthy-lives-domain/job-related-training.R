library(readr)
library(readxl)
library(httr)
library(dplyr)
library(tidyr)

# Load population estimates
# source: https://www.nrscotland.gov.uk/statistics-and-data/statistics/statistics-by-theme/population/population-estimates/mid-year-population-estimates/mid-2019
GET(
  "https://www.nrscotland.gov.uk/files//statistics/population-estimates/mid-19/mid-year-pop-est-19-data.xlsx",
  write_disk(tf <- tempfile(fileext = ".xlsx"))
)

pop_raw <- read_excel(tf, sheet = "Table 2", range = "A4:C38")

# Calculate population estimates
pop <-
  pop_raw %>%
  slice(-(1:2)) %>%
  select(lad_code = `Area code1`, pop_count = `All Ages`)

# The NOMIS API query creator was used to generate the url in the GET request:
# Source: https://www.nomisweb.co.uk/datasets/apsnew
# Data Set: Annual Population Survery
# Indicator: T22a (Job related training (SIC 2007)

training_raw <- read_csv("http://www.nomisweb.co.uk/api/v01/dataset/NM_17_1.data.csv?geography=1946157405...1946157408,1946157416,1946157409...1946157415,1946157418...1946157424,1946157417,1946157425...1946157436,2013265931&date=latest&cell=404693507,404694275&measures=20100,20701&select=date_name,geography_name,geography_code,cell_name,measures_name,obs_value,obs_status_name")

# Keep vars of interest
training <-
  training_raw %>%
  select(
    lad_name = GEOGRAPHY_NAME,
    lad_code = GEOGRAPHY_CODE,
    measures_name = MEASURES_NAME,
    count = OBS_VALUE
  ) %>%
  filter(measures_name == "Value") %>%
  select(-measures_name)

# Remove Scotland Aggregate and add counts for part-time and full-time employment
training <-
  training %>%
  filter(lad_code != "S92000003") %>%
  group_by(lad_code) %>%
  summarise(count = sum(count))

# Join population counts and calculate relative rate
training <-
  training %>%
  left_join(pop, by = "lad_code") %>% 
  mutate(job_related_training_percent = count/pop_count) %>% 
  select(-count, -pop_count)

write_rds(training, "data/vulnerability/health-inequalities/scotland/job-related-training.rds")

# The training counts (2011 lad codes) needs matching to the population counts (2019 lad codes)
# See: https://www.opendata.nhs.scot/dataset/geography-codes-and-labels
# See: https://github.com/drkane/geo-lookups/blob/master/la_all_codes.csv