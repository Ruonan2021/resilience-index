library(httr)
library(dplyr)
library(readr)
library(readxl)
library(stringr)

GET(
  "https://www.hse.gov.uk/statistics/tables/ridreg.xlsx",
  write_disk(tf <- tempfile(fileext = ".xlsx"))
)

workplace_safety_raw <-
  read_excel(
    tf,
    sheet = "Table 2_Non fatal injuries",
    skip = 8,
    col_names = c(
      "date",
      "lad_code",
      "lad_name",
      "auth_type",
      "blank_1",
      "total_reported_count",
      "total_reported_specified_count",
      "total_reported_7_day_count",
      "blank_2",
      "total_reported_per_100000",
      "total_reported_specified_per_100000",
      "total_reported_7_day_per_100000"
    )
  )

workplace_safety <-
  workplace_safety_raw %>%
  filter(date == "2019/20p") %>%
  select(lad_code, "total_reported_per_100000") %>%
  filter(str_detect(lad_code, "^S")) %>%
  filter(lad_code != "S92000003") %>%
  mutate(total_reported_per_100000 = as.double(total_reported_per_100000))

write_rds(workplace_safety, "data/vulnerability/health-inequalities/scotland/workplace-safety.rds")