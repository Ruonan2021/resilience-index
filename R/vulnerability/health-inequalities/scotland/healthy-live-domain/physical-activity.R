library(readr)
library(dplyr)
library(readxl)
library(httr)

# Data Zone and Intermediate Zone 2011 Lookups
# source: https://www.gov.scot/publications/scottish-index-of-multiple-deprivation-2020-data-zone-look-up/
GET(
  "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-data-zone-look-up-file/documents/scottish-index-of-multiple-deprivation-data-zone-look-up/scottish-index-of-multiple-deprivation-data-zone-look-up/govscot%3Adocument/SIMD_2020_Datazone_lookup_tool.xlsx",
  write_disk(tf <- tempfile(fileext = ".xlsx"))
)

lookup <-
  read_excel(tf, sheet = "SIMD 2020v2 DZ lookup data") %>%
  select(data_zone = DZ, intermediate_zone = IZcode, lad_code = LAcode) %>%
  distinct()

unlink(tf)
rm(tf)

# Source: https://statistics.gov.scot/slice?dataset=http%3A%2F%2Fstatistics.gov.scot%2Fdata%2Fscottish-health-survey-local-area-level-data&http%3A%2F%2Fpurl.org%2Flinked-data%2Fcube%23measureType=http%3A%2F%2Fstatistics.gov.scot%2Fdef%2Fmeasure-properties%2Fpercent&http%3A%2F%2Fpurl.org%2Flinked-data%2Fsdmx%2F2009%2Fdimension%23refPeriod=http%3A%2F%2Freference.data.gov.uk%2Fid%2Fgregorian-interval%2F2016-01-01T00%3A00%3A00%2FP4Y
health_survey <-
  read_csv("https://statistics.gov.scot/downloads/cube-table?uri=http%3A%2F%2Fstatistics.gov.scot%2Fdata%2Fscottish-health-survey-local-area-level-data")

physical_activity <-
  health_survey %>% 
  filter(
    `Scottish Health Survey Indicator` == "Summary activity levels: Meets recommendations",
    Measurement == "Percent",
    Sex == "All",
    DateCode == "2016-2019"
  ) %>%
  select(
    lad_code = FeatureCode,
    activity_levels_met_percent = Value
  ) %>%
  filter(lad_code %in% (lookup %>% distinct(lad_code) %>% pull()))

# NOTE: ~half the LA's are missing