library(httr)
library(readr)
library(readxl)
library(stringr)
library(dplyr)

GET(
  "https://www.ons.gov.uk/file?uri=/employmentandlabourmarket/peopleinwork/earningsandworkinghours/adhocs/10743annualsurveyofhoursandearningsasheestimatesofthenumberandproportionofemployeejobswithhourlypaybelowthelivingwagebyworkgeographylocalauthorityandparliamentaryconstituencyukapril2018andapril2019/20182019livingwagebyworkgeography.zip",
  write_disk(tf <- tempfile(".zip"))
)

unzip(tf, exdir = tempdir())

low_pay_raw <-
  read_excel(
    list.files(tempdir(),
      pattern = "Work Geography LW Table 7.1a   lwfmgx 2019.xls",
      full.names = TRUE
    ),
    sheet = "All",
    range = "B394:D425",
    col_names = c("lad_code", "count_jobs", "low_pay_percent")
  )

low_pay <-
  low_pay_raw %>%
  select(-count_jobs) %>%
  mutate(low_pay_percent = str_replace_all(low_pay_percent, "x", NA_character_)) %>%
  mutate(low_pay_percent = as.double(low_pay_percent))

write_rds(low_pay, "data/vulnerability/health-inequalities/scotland/healthy-lives/low-pay.rds")

# Data is missing from four LA's as:
# "Estimates with a CV greater than 20% are suppressed from publication on quality grounds,
# along with those for which there is a risk of disclosure of individual employees or employers."