##
## Create a shapefile of Scottish settlements/buildings with Heath Index scores/deciles assigned
##
library(tidyverse)
library(geographr)
library(httr)
library(sf)

# Load Scottish Council Area boundaries
lad <- geographr::boundaries_lad %>% 
  filter(str_sub(lad_code, 1, 1) == "S")

# Load Scottish Health Index
# For testing, make up health index scores
lad <- 
  lad %>% 
  mutate(`Health vulnerability decile (test)` = round(runif(n(), 1, 10), 0))

# Load shapefile of buildings in Scotland from https://data.humdata.org/dataset/hotosm_gbr_scotland_buildings/resource/aecc7790-f8ef-4468-b4ac-fd34fec281ca
GET("https://export.hotosm.org/downloads/d836366c-7d9b-453c-9e02-8f1e5114ffc6/hotosm_gbr_scotland_buildings_polygons_shp.zip",
    write_disk(tf <- tempfile(fileext = ".zip")))

unzip(tf, exdir = (td <- tempdir()))

scot_buildings <- read_sf(file.path(td, "hotosm_gbr_scotland_buildings_polygons.shp"))

# Assign health index scores/deciles to each building based on the Council Area it's in
scot_buildings <- 
  scot_buildings %>% 
  st_join(lad)

# Save, because it takes a long time to calculate
write_sf(scot_buildings, "data/vulnerability/health-inequalities/scotland/scotland_buildings_with_health_index.shp")
