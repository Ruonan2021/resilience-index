# ---- Load ----
library(tidyverse)
library(httr)
library(jsonlite)

# ---- Parse data ----
# The data from health stat wales can't be easily extracted.
#
# But, the raw JSON underpinning the tables can be extract by clicking on the
# "Open Data" tab at the bottom of the page, and then clicking the "Items" link.

resp <-
  GET(
    "http://open.statswales.gov.wales/en-gb/dataset/hlth5052"
  )

# Check a JSON response is returnd
if (http_type(resp) != "application/json") {
  stop(
    "API did not return json",
    call. = FALSE
  )
}

# TODO:
# Need to paginate through the response:


# Parse JSON data
fromJSON(
  content(
    resp,
    as = "text",
    encoding = "UTF-8"
  ),
  flatten = TRUE
) %>%
as_tibble() %>% 
  pull(value) %>% 
  as_tibble() %>% 
  glimpse()
