# ---- Load ----
library(tidyverse)
library(httr)
library(jsonlite)

# ---- Parse data ----
# The data from health stat wales can't be easily extracted.
#
# The raw JSON underpinning the tables can be found by clicking on the
# "Open Data" tab at the bottom of the page, and then clicking the "Dataset"
# link.

# Parse json response
parse_resp <-
  function(resp) {
    if (http_type(resp) != "application/json") {
      stop("API did not return json",
        call. = FALSE
      )
    }

    if (http_error(resp) == TRUE) {
      stop("The request failed")
    } else {
      parsed_content <-
        fromJSON(
          content(
            resp,
            as = "text",
            encoding = "UTF-8"
          ),
          flatten = TRUE
        )

      tibbled_content <- as_tibble(parsed_content$value)

      return(tibbled_content)
    }
  }

# Parse through paginated json responses
extract_json <-
  function(url) {
    resp <- GET(url)
    
    total_json <- parse_resp(resp)

    while (!is.null(content(resp)$odata.nextLink)) {
      
      resp <- GET(content(resp)$odata.nextLink)

      next_json <- parse_resp(resp)

      total_json <- rbind(total_json, next_json)
    }

    return(total_json)
  }

raw <- extract_json("http://open.statswales.gov.wales/en-gb/dataset/hlth5052")
