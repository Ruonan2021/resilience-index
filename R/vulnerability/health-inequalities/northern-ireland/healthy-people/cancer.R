library(tidyverse)
library(httr)
library(readODS)
library(geographr)
library(sf)

source("R/utils.R")

pop_ni <-
  population_lad %>%
  filter_codes(lad_code, "^N") %>%
  select(lad_code, total_population)

GET(
  "https://www.ninis2.nisra.gov.uk/Download/Health%20and%20Social%20Care/Disease%20Prevalence%20(Quality%20Outcomes%20Framework)%20(administrative%20geographies).ods",
  write_disk(tf <- tempfile(fileext = ".ods"))
)

raw <-
  read_ods(
    tf,
    sheet = "LGD2014",
    range = "B4:AL15"
  )

cancer <-
  raw %>%
  as_tibble() %>%
  select(
    lad_code = `LGD2014 Code`,
    cancer_patients = `Patients on the Cancer Register`
  ) %>%
  left_join(pop_ni) %>%
  mutate(
    cancer_rate_per_1000 = (cancer_patients / total_population) * 1000
  ) %>%
  select(lad_code, cancer_rate_per_1000)

write_rds(cancer, "data/vulnerability/health-inequalities/northern-ireland/healthy-people/cancer.rds")