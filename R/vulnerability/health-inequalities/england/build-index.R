# ---- Load libraries ----
library(tidyverse)
library(readxl)
library(geographr)
library(httr)
library(sf)

source("R/utils.R")

# ---- Load data ----
GET(
  "https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/healthandsocialcare/healthandwellbeing/datasets/healthindexengland/2015to2018/hibetadatatablesv2.xlsx",
  write_disk(tf <- tempfile(fileext = ".xlsx"))
)

hi <- read_excel(tf, sheet = "2018", skip = 11)

# ---- Clean ----
hi_clean <-
  hi %>%
  slice(1:162) %>%
  slice(-1:-2) %>%
  select(
    county_ua_code = ...1,
    overall_health_index = ...6,
    healthy_lives = `Healthy Lives...9`,
    healthy_places = `Healthy Places...10`,
    healthy_people = `Healthy People...11`
  ) %>%
  mutate(healthy_people = as.double(healthy_people)) %>%
  drop_na()

# Some areas have been combined. Separate them.
hi_missing <-
  hi_clean %>%
  filter(
    county_ua_code == "E06000052" | # Cornwall
      county_ua_code == "E09000012" | # Hackney
      county_ua_code == "E06000060" # Buckinhamshire
  ) %>%
  mutate(
    county_ua_code = case_when(
      county_ua_code == "E06000052" ~ "E06000053", # Isles of Scilly
      county_ua_code == "E09000012" ~ "E09000001", # City of London
      county_ua_code == "E06000060" ~ "E10000002" # Buckinghamshire
    )
  )

hi_complete <-
  bind_rows(
    hi_clean,
    hi_missing
  )

# Remove aggregate locations
hi_england <-
  boundaries_counties_ua %>%
  filter(str_detect(county_ua_code, "^E")) %>%
  left_join(
    hi_complete,
    by = "county_ua_code"
  ) %>%
  as_tibble() %>%
  select(-geometry)

# Convert scores to ranks and deciles
hi_index_ranks <-
  hi_england %>%
  normalise_indicators() %>%
  mutate(across(where(is.numeric), inverse_rank)) %>%
  rename_with(
    ~ str_c(.x, "rank", sep = "_"),
    where(is.numeric)
  )

hi_index_quantiles <-
  hi_england %>%
  normalise_indicators() %>%
  mutate(across(where(is.numeric), inverse_rank)) %>%
  mutate(across(where(is.numeric), quantise)) %>%
  rename_with(
    ~ str_c(.x, "quantile", sep = "_"),
    where(is.numeric)
  )

hi_index <-
  hi_index_ranks %>%
  left_join(hi_index_quantiles)

# Check distirbutions of quantiles
hi_index %>%
  pivot_longer(
    cols = ends_with("_quantile"),
    names_to = "domain",
    values_to = "quantile"
  ) %>%
  ggplot(aes(x = quantile, fill = domain)) +
  geom_density(alpha = .5) +
  facet_wrap(vars(domain)) +
  theme_minimal()

write_csv(
  hi_index,
  "data/vulnerability/health-inequalities/england/health-index-2018.csv"
)